<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>2-3반 학급 사이트</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body{
      margin:0;
      font-family:system-ui,sans-serif;
      background:#f8fafc;
      color:#1f2937;
      transition:background .3s,color .3s;
    }
    body.dark{background:#0f172a;color:#f1f5f9}
    header{
      background:linear-gradient(135deg,#4f46e5,#3b82f6);
      color:white;padding:1rem 1.5rem;
      display:flex;justify-content:space-between;align-items:center;
    }
    nav{display:flex;gap:.8rem;flex-wrap:wrap}
    .wrap{max-width:1000px;margin:20px auto;padding:0 1rem}
    h2{font-size:1.2rem;font-weight:600;margin:0 0 .75rem 0}
    .card{
      background:white;border-radius:1rem;padding:1.2rem;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);margin-bottom:20px
    }
    header h1 {
  margin: 0;
  font-size: 1.6rem;   /* 제목 크게 */
  font-weight: 800;    /* 더 두껍게 */
  letter-spacing: 1px; /* 자간 조금 */
}

nav a {
  color: white;
  text-decoration: none;
  font-size: 1rem;      /* 메뉴 글씨 조금 크게 */
  font-weight: 600;     /* 굵게 */
}

nav a:hover {
  text-decoration: underline;
  color: #e0e7ff;       /* hover 시 연보라색 */
}

    body.dark .card{background:#1e293b}
    .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .grid-4{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
    .btn{
      padding:.55rem .9rem;border-radius:.6rem;border:1px solid #d1d5db;
      background:white;font-size:.9rem;cursor:pointer
    }
    .btn.primary{background:#60a5fa;color:white;border:none}
    .btn.primary:hover{background:#3b82f6}
    body.dark .btn{background:#334155;color:#f1f5f9;border-color:#475569}
    ul{margin:0;padding-left:1rem}
    .seat{background:#f9fafb;border:1px solid #e2e8f0;border-radius:.5rem;padding:.5rem;text-align:center}
    body.dark .seat{background:#334155;border-color:#475569}
    .gallery-item{border:1px solid #e2e8f0;border-radius:.75rem;padding:.9rem;text-align:center;background:#fafafa}
    body.dark .gallery-item{background:#334155;border-color:#475569}
    .muted{color:#6b7280;font-size:.85rem}
    body.dark .muted{color:#94a3b8}

    /* 반응형 */
    @media(max-width:640px){
      header{flex-direction:column;align-items:flex-start}
      nav{display:none;flex-direction:column;gap:.5rem;margin-top:.5rem}
      nav.show{display:flex}
      .hamburger{display:block;cursor:pointer;margin-top:.5rem}
    }
    @media(min-width:641px){
      .hamburger{display:none}
    }
    /* 자리 스타일 */
#seat-map {
  display: grid;
  grid-template-columns: repeat(6, 1fr); /* ✅ 6열 */
  grid-auto-rows: auto;
  gap: 10px;
}

.seat {
  background:#f9fafb;
  border:1px solid #e2e8f0;
  border-radius:.5rem;
  padding:.7rem 1rem;
  text-align:center;
}
body.dark .seat {
  background:#334155;
  border-color:#475569;
  color:#f1f5f9;
}
.seat {
  background:#f9fafb;
  border:1px solid #e2e8f0;
  border-radius:.5rem;
  padding:.7rem 1rem;
  text-align:center;
  cursor:grab;  /* 드래그 가능 마우스 표시 */
}
.seat:active {
  cursor:grabbing;
}
.seat.locked {
  background:#e0f2fe;  /* 고정된 자리 하늘색 표시 */
  border-color:#0284c7;
}
.notice-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  border-bottom: 1px solid #e5e7eb;
  padding: 0.6rem 0;
}
.notice-item:last-child {
  border-bottom: none;
}
.notice-thumb {
  width: 100px;
  height: 140px;
  object-fit: cover;
  border-radius: 0.5rem;
  cursor: pointer;
  transition: transform 0.2s;
}
#image-modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.8);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
#image-modal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 0.5rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.notice-body {
  flex: 1;
}
.notice-title {
  font-weight: 700;
  color: #1e3a8a;
  font-size: 0.95rem;
  margin-bottom: 0.25rem;
}
.notice-date {
  font-size: 0.75rem;
  color: #6b7280;
  margin-bottom: 0.3rem;
}
.notice-content {
  font-size: 0.85rem;
  color: #374151;
  white-space: pre-line;
}
body.dark .notice-title { color: #93c5fd; }
body.dark .notice-date { color: #9ca3af; }
body.dark .notice-content { color: #e5e7eb; }

  </style>
</head>
<body>
  <header>
    <div>
      <h1>🏫 2-3반 학급 사이트</h1>
      <div class="hamburger" onclick="toggleMenu()">☰ 메뉴</div>
    </div>
    <nav id="nav">
      <a href="#notices">공지</a>
      <a href="#assign">과제</a>
      <a href="#timetable">시간표</a>
      <a href="#clean">청소/자리</a>
      <a href="#test">테스트</a>
      <a href="#attendance">출석</a>
      <a href="#gallery">갤러리</a>
      <a href="#points">포인트</a>
      <a href="#vote">투표</a>
      <button class="btn" onclick="toggleDark()">🌙 모드</button>
    </nav>
  </header>

  <div class="wrap">

    <!-- 빠른메뉴 -->
    <div class="card grid-4">
      <button class="btn primary" onclick="location.hash='#assign'">📝 과제</button>
      <button class="btn primary" onclick="location.hash='#notices'">📢 공지</button>
      <button class="btn primary" onclick="location.hash='#clean'">🧹 청소/자리</button>
      <button class="btn primary" onclick="location.hash='#test'">📝 테스트</button>
    </div>

    <!-- 공지 -->
    <div id="notices" class="card">
      <h2>📢 공지사항</h2>
      <div id="notice-list" class="muted">불러오는 중…</div>
    </div>

    <!-- 과제 + 시간표 -->
    <div class="grid-2">
      <div id="assign" class="card">
        <h2>📝 과제</h2>
        <div id="assign-list" class="muted">불러오는 중…</div>
      </div>
      <div id="timetable" class="card">
        <h2>🗓️ 시간표</h2>
        <input type="date" id="timetable-date" />
        <button class="btn primary" onclick="loadTimetableByDate()">📅 불러오기</button>
        <div id="timetable-grid"></div>
      </div>
    </div>

<div id="clean" class="card">
  <h2>🧹 청소 당번 & 🪑 자리 배치(드래그 = 이동, 우클릭 = 고정)</h2>
  <button class="btn" onclick="shuffleSeats()">🔄 자리 바꾸기</button>
  <div id="seat-map" style="margin-top:1rem"></div>
</div>  

    <!-- 출석 -->
    <div id="attendance" class="card">
      <h2>✅ 출석 체크</h2>
      <ul id="att-list"></ul>
    </div>

    <!-- 간단 테스트 -->
    <div id="test" class="card">
      <h2>📝 간단 테스트</h2>
      <p class="muted">문제: 5 × 6 = ?</p>
      <input id="test-answer" type="number" placeholder="정답 입력"
             style="padding:.5rem;border:1px solid #cbd5e1;border-radius:.5rem" />
      <button class="btn primary" onclick="checkTest()">제출</button>
      <div id="test-result" style="margin-top:.5rem"></div>
    </div>

    <!-- 갤러리 -->
    <div id="gallery" class="card">
      <h2>📂 자료실 & 갤러리</h2>
      <div id="files" class="grid-4"></div>
    </div>

    <!-- 포인트 -->
    <div id="points" class="card">
      <h2>🏆 포인트 보드</h2>
      <div id="points-list"></div>
    </div>

    <!-- 투표 -->
    <div id="vote" class="card">
      <h2>🗳️ 학급 투표</h2>
      <p>체육 시간에 하고 싶은 운동은?</p>
      <button class="btn" onclick="submitVote('축구')">⚽ 축구</button>
      <button class="btn" onclick="submitVote('농구')">🏀 농구</button>
      <button class="btn" onclick="submitVote('피구')">🏐 피구</button>
      <div id="vote-result" class="muted" style="margin-top:.5rem"></div>
    </div>

  </div>
<div id="image-modal" onclick="closeModal()">
  <img id="modal-img" src="" alt="확대 이미지" />
</div>
  <script>
  const $ = (id) => document.getElementById(id);

  /* 메뉴 토글 */
  function toggleMenu(){ $('nav').classList.toggle('show'); }

  /* 다크 모드 */
  function toggleDark(){ document.body.classList.toggle('dark'); }

  /* Supabase 클라이언트 */
  const client = window.supabase.createClient(
    "https://ucmzrkwrsezfdjnnwsww.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjbXpya3dyc2V6ZmRqbm53c3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NDIzODcsImV4cCI6MjA2ODQxODM4N30.rvLItmDStjWb3GfECnCXocHvj-CMTfHfD1CHsAHOLaw"
  );

  /* 공지 */
  async function loadNotices(){
  try{
    const { data, error } = await client
      .from("notices")
      .select("title, content, created_at, image_url")
      .eq("grade",2).eq("class_num",3)
      .order("created_at",{ascending:false});
    if(error) throw error;

    if (data && data.length) {
      $('notice-list').innerHTML = data.map(n => {
        const date = new Date(n.created_at).toLocaleDateString("ko-KR", {
          year: "numeric", month: "2-digit", day: "2-digit"
        });
        return `
          <div class="notice-item">
            ${n.image_url 
    ? `<img src="${n.image_url}" class="notice-thumb" alt="공지 이미지" onclick="openModal('${n.image_url}')">`
    : ""}
            <div class="notice-body">
              <div class="notice-title">📌 ${n.title}</div>
              <div class="notice-date">${date}</div>
              <div class="notice-content">${n.content}</div>
            </div>
          </div>
        `;
      }).join("");
    } else {
      $('notice-list').innerHTML = "<p>공지 없음</p>";
    }
  }catch(e){
    console.error(e);
    $('notice-list').innerHTML="❌ 공지 불러오기 오류";
  }
}

  /* 과제 */
  async function loadAssignments(){
    try{
      const { data, error } = await client
        .from("assignments")
        .select("title, deadline")
        .eq("grade",2).eq("class_num",3)
        .order("deadline",{ascending:true});
      if(error) throw error;
      $('assign-list').innerHTML = (data && data.length)
        ? "<ul>"+data.map(a=>`<li>${a.title} (${a.deadline})</li>`).join("")+"</ul>"
        : "과제 없음";
    }catch(e){
      console.error(e);
      $('assign-list').innerHTML="❌ 과제 불러오기 오류";
    }
  }
  
async function loadTimetableByDate() {
  const API_KEY = "28ca0f05af184e8ba231d5a949d52db2"; 
  const ATPT_OFCDC_SC_CODE = "J10";   // 경기도교육청
  const SD_SCHUL_CODE = "7679111";    // 봉담중학교
  const grade = 2;
  const classNum = 3;

  const input = document.getElementById("timetable-date");

  // ✅ input 값이 있으면 그걸 쓰고, 없으면 오늘 날짜
  let dateStr;
  if (input.value && input.value.trim() !== "") {
    dateStr = input.value.replace(/-/g, "");
  } else {
    const today = new Date();
    dateStr = today.getFullYear() +
      String(today.getMonth() + 1).padStart(2, '0') +
      String(today.getDate()).padStart(2, '0');
  }

  const year = dateStr.slice(0, 4);
  const month = parseInt(dateStr.slice(4, 6));
  const semester = (month <= 8) ? 1 : 2;

  const url = `https://open.neis.go.kr/hub/misTimetable?KEY=${API_KEY}&Type=json&ATPT_OFCDC_SC_CODE=${ATPT_OFCDC_SC_CODE}&SD_SCHUL_CODE=${SD_SCHUL_CODE}&AY=${year}&SEM=${semester}&ALL_TI_YMD=${dateStr}&GRADE=${grade}&CLASS_NM=${classNum}`;

  const container = document.getElementById("timetable-grid");
  container.innerHTML = "<p>시간표 불러오는 중...</p>";

  try {
    const res = await fetch(url);
    const json = await res.json();

    container.innerHTML = "";

    if (json.misTimetable && json.misTimetable[1]) {
      const rows = json.misTimetable[1].row;
      rows.sort((a, b) => parseInt(a.PERIO) - parseInt(b.PERIO));

      rows.forEach(r => {
        const item = document.createElement("div");
        item.innerHTML = `<strong>${r.PERIO}교시</strong> : ${r.ITRT_CNTNT}`;
        container.appendChild(item);
      });
    } else {
      container.innerHTML = "<p>❌ 시간표 데이터 없음</p>";
    }
  } catch (err) {
    console.error(err);
    container.innerHTML = "<p>❌ 시간표 불러오기 오류</p>";
  }
}


  /* 출석 */
  async function loadAttendance(){
    try{
      const { data, error } = await client
        .from("users")
        .select("name")
        .eq("grade",2).eq("class_num",3)
        .not("name","ilike","%선생님%")
        .order("student_number");
      if(error) throw error;
      const ul=$('att-list'); ul.innerHTML="";
      (data||[]).forEach(u=>{
        const li=document.createElement('li');
        li.innerHTML=`${u.name}
          <button class="btn" onclick="mark(this,'출석')">출석</button>
          <button class="btn" onclick="mark(this,'지각')">지각</button>
          <button class="btn" onclick="mark(this,'결석')">결석</button>`;
        ul.appendChild(li);
      });
    }catch(e){
      console.error(e);
      $('att-list').innerHTML="❌ 출석 불러오기 오류";
    }
  }
  function mark(btn,status){
    btn.parentElement.innerHTML=btn.parentElement.textContent.split(' ')[0]+" - "+status;
  }

  /* 테스트/포인트 */
  function checkTest(){
    const val=Number($('test-answer').value),res=$('test-result');
    let score=localStorage.getItem('quizScore')||0;
    if(val===30){res.textContent='✅ 정답! +5점';res.style.color='green';score=Number(score)+5;}
    else{res.textContent='❌ 오답';res.style.color='red';}
    localStorage.setItem('quizScore',score);
    loadPoints();
  }
  function loadPoints(){
    const score=localStorage.getItem('quizScore')||0;
    $('points-list').innerHTML='<p>내 점수: '+score+'점</p>';
  }

  /* 갤러리 */
  function loadGallery(){
    $('files').innerHTML='<div class="gallery-item">사진 모음</div><div class="gallery-item">수학 프린트</div>';
  }

  /* 투표 */
  function submitVote(choice){
    localStorage.setItem("voteChoice",choice);
    $('vote-result').textContent="내 선택: "+choice;
  }
  function loadVote(){
    const saved=localStorage.getItem("voteChoice");
    if(saved) $('vote-result').textContent="내 선택: "+saved;
  }

  /* 자리배치 (드래그&드롭 + 고정) */
  let seatData = [];      // 학생 이름 배열
  let lockedSeats = {};   // {index: true}
  

  function renderSeats(list){
    const container = $('seat-map');
    container.innerHTML = '';

    list.forEach((name, i) => {
      const seatDiv = document.createElement('div');
      seatDiv.className = 'seat';
      seatDiv.textContent = name;

      if(lockedSeats[i]) seatDiv.classList.add('locked');

      seatDiv.draggable = true;
      seatDiv.dataset.index = i;

      seatDiv.addEventListener("dragstart", e => {
        e.dataTransfer.setData("index", String(i));
      });
      seatDiv.addEventListener("dragover", e => e.preventDefault());
      seatDiv.addEventListener("drop", e => {
        e.preventDefault();
        const from = parseInt(e.dataTransfer.getData("index"), 10);
        const to = parseInt(e.currentTarget.dataset.index, 10);
        swapSeats(from, to);
      });

      // 우클릭 고정/해제
      seatDiv.addEventListener("contextmenu", e => {
        e.preventDefault();
        lockedSeats[i] = !lockedSeats[i];
        renderSeats(seatData);
      });

      container.appendChild(seatDiv);
    });
  }

  function swapSeats(from, to){
    if(Number.isNaN(from) || Number.isNaN(to)) return;
    if(lockedSeats[from] || lockedSeats[to]) return;
    [seatData[from], seatData[to]] = [seatData[to], seatData[from]];
    renderSeats(seatData);
  }

  function shuffleSeats(){
    if(!seatData.length) return;
    const arr = [...seatData];
    for(let i=arr.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      if(!lockedSeats[i] && !lockedSeats[j]){
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }
    seatData = arr;
    renderSeats(seatData);
  }
  window.shuffleSeats = shuffleSeats; // 버튼에서 호출 가능하도록

  async function loadSeats(){
    try{
      const { data, error } = await client
        .from("users")
        .select("name")
        .eq("grade", 2)
        .eq("class_num", 3)
        .not("name", "ilike", "%선생님%")
        .order("student_number");
      if(error) throw error;
      seatData = (data||[]).map(u => u.name);
      renderSeats(seatData);
    }catch(e){
      console.error(e);
      $('seat-map').innerHTML = "❌ 자리 불러오기 오류";
    }
  }

  /* DOMContentLoaded */
  document.addEventListener('DOMContentLoaded',()=>{
    loadNotices();
    loadAssignments();
    loadAttendance();
    loadSeats();
    loadGallery();
    loadPoints();
    loadVote();
    const input = document.getElementById("timetable-date");
    if (!input.value) {   // 사용자가 직접 선택한 값이 없을 때만 기본값 세팅
      const today = new Date();
      input.value = today.toISOString().slice(0, 10);
    }
    loadTimetableByDate();  // 기본적으로 오늘 시간표 보여주기
  });
  function openModal(src) {
  document.getElementById("modal-img").src = src;
  document.getElementById("image-modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("image-modal").style.display = "none";
}
</script>

</body>
</html>
